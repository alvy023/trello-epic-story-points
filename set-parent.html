<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Parent Card</title>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script>
        var t = TrelloPowerUp.iframe();

        // Fetch the list of cards to select as a parent
        t.get('board', 'shared', 'epicsListId').then(function(epicsListId) {
            return t.cards('id', 'name', 'idList').then(function(cards) {
                var epicsCards = cards.filter(card => card.idList === epicsListId);
                var select = document.getElementById("parentCardSelect");
                epicsCards.forEach(card => {
                    var option = document.createElement("option");
                    option.value = card.id;
                    option.text = card.name;
                    select.add(option);
                });
            });
        });

        function saveParent() {
            var select = document.getElementById("parentCardSelect");
            var parentId = select.value;
            var parentName = select.options[select.selectedIndex].text;

            if (!parentId) return;

            t.get('card', 'id').then(function(card) {
                return t.get('card', 'shared', 'parentCardId').then(function(oldParentId) {
                    var updates = [
                        t.set('card', 'shared', {
                            parentCardId: parentId,
                            parentCardName: parentName
                        }),
                        t.get('board', 'shared', 'childCards').then(function(boardChildren) {
                            boardChildren = boardChildren || {};
                            
                            // Remove from old parent
                            if (oldParentId && boardChildren[oldParentId]) {
                                boardChildren[oldParentId] = boardChildren[oldParentId].filter(c => c.id !== card.id);
                            }
                            
                            // Add to new parent
                            boardChildren[parentId] = boardChildren[parentId] || [];
                            if (!boardChildren[parentId].some(c => c.id === card.id)) {
                                boardChildren[parentId].push({ id: card.id, name: card.name });
                            }

                            return t.set('board', 'shared', 'childCards', boardChildren);
                        })
                    ];
                    
                    return Promise.all(updates).then(() => t.closePopup());
                });
            });
        }

        function removeParent() {
            t.get('card', 'id').then(function(card) {
                return t.get('card', 'shared', 'parentCardId').then(function(oldParentId) {
                    var updates = [
                        t.remove('card', 'shared', ['parentCardId', 'parentCardName']),
                        t.get('board', 'shared', 'childCards').then(function(boardChildren) {
                            if (oldParentId && boardChildren && boardChildren[oldParentId]) {
                                boardChildren[oldParentId] = boardChildren[oldParentId].filter(c => c.id !== card.id);
                                return t.set('board', 'shared', 'childCards', boardChildren);
                            }
                        })
                    ];

                    return Promise.all(updates).then(() => t.closePopup());
                });
            });
        }
    </script>
</head>
<body>
    <h2>Set Parent Card</h2>
    <select id="parentCardSelect">
        <option value="">Select Parent Card</option>
    </select>
    <button onclick="saveParent()">Save</button>
    <button onclick="removeParent()">Remove</button>
</body>
</html>