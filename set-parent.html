<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Parent Card</title>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script>
        var t = TrelloPowerUp.iframe();

        console.log('Power-Up iframe initialized');

        t.get('board', 'shared', 'epicsListId').then(function(epicsListId) {
            return t.cards('all').then(function(cards) {
                var epicsCards = cards.filter(card => card.idList === epicsListId);
                console.log('Epics Cards:', epicsCards);
                var select = document.getElementById("parentCardSelect");
                epicsCards.forEach(card => {
                    var option = document.createElement("option");
                    option.value = card.id;
                    option.text = card.name;
                    select.add(option);
                });
            }).catch(function(error) {
                console.error('Error fetching cards:', error);
            });
        }).catch(function(error) {
            console.error('Error fetching epics list ID:', error);
        });

        function saveParent() {
            var select = document.getElementById("parentCardSelect");
            var parentId = select.value;
            var parentName = select.options[select.selectedIndex].text;

            console.log('Selected Parent ID:', parentId);
            console.log('Selected Parent Name:', parentName);

            if (!parentId) return;

            t.card('id', 'name').then(function(card) {
                console.log('Current Card:', card);
                return t.get('card', 'shared', 'parentCardId').then(function(oldParentId) {
                    console.log('Old Parent ID:', oldParentId);
                    var updates = [
                        t.set('card', 'shared', {
                            parentCardId: parentId,
                            parentCardName: parentName
                        }),
                        t.get('board', 'shared', 'childCards').then(function(boardChildren) {
                            boardChildren = boardChildren || {};

                            if (oldParentId && boardChildren[oldParentId]) {
                                boardChildren[oldParentId] = boardChildren[oldParentId].filter(c => c.id !== card.id);
                                console.log('Removed from old parent:', oldParentId, boardChildren[oldParentId]);
                            }

                            boardChildren[parentId] = boardChildren[parentId] || [];
                            if (!boardChildren[parentId].some(c => c.id === card.id)) {
                                boardChildren[parentId].push({ id: card.id, name: card.name });
                                console.log('Added to new parent:', parentId, boardChildren[parentId]);
                            }

                            return t.set('board', 'shared', 'childCards', boardChildren);
                        })
                    ];

                    return Promise.all(updates).then(() => {
                        console.log('Parent saved successfully');
                        t.closePopup();
                        updateParentCard(parentId);
                    });
                });
            }).catch(function(error) {
                console.error('Error saving parent:', error);
            });
        }

        function removeParent() {
            t.card('id', 'name').then(function(card) {
                console.log('Current Card:', card);
                return t.get('card', 'shared', 'parentCardId').then(function(oldParentId) {
                    console.log('Old Parent ID:', oldParentId);
                    var updates = [
                        t.remove('card', 'shared', ['parentCardId', 'parentCardName']),
                        t.get('board', 'shared', 'childCards').then(function(boardChildren) {
                            if (oldParentId && boardChildren && boardChildren[oldParentId]) {
                                boardChildren[oldParentId] = boardChildren[oldParentId].filter(c => c.id !== card.id);
                                console.log('Removed from old parent:', oldParentId, boardChildren[oldParentId]);
                                return t.set('board', 'shared', 'childCards', boardChildren);
                            }
                        })
                    ];

                    return Promise.all(updates).then(() => {
                        console.log('Parent removed successfully');
                        t.closePopup();
                        updateParentCard(oldParentId);
                    });
                });
            }).catch(function(error) {
                console.error('Error removing parent:', error);
            });
        }

        function updateParentCard(parentId) {
            return t.get('board', 'shared', 'childCards').then(function (boardChildren) {
                if (!boardChildren || !boardChildren[parentId]) {
                    return Promise.resolve(); // No children for this parent, nothing to update
                }

                const children = boardChildren[parentId];
                let totalPoints = 0;

                return Promise.all(
                    children.map(child =>
                        t.get(child.id, "shared", "storyPoints").then(points => {
                            // points = parseInt(points, 10) || 0; // Ensure points is a number
                            totalPoints += points;
                        })
                    )
                ).then(() => {
                    // Set the total story points on the parent card
                    return t.set(parentId, "shared", "totalPoints", totalPoints);
                });
            });
        }

    </script>
</head>
<body>
    <h2>Set Parent Card</h2>
    <select id="parentCardSelect">
        <option value="">Select Parent Card</option>
    </select>
    <button onclick="saveParent()">Save</button>
    <button onclick="removeParent()">Remove</button>
</body>
</html>