<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Child Cards</title>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <script>
        var t = TrelloPowerUp.iframe();

        t.card('id').then(function(card) {
            console.log('Current Card:', card);
            return t.get('board', 'shared', 'childCards').then(function(boardChildren) {
                var children = (boardChildren && boardChildren[card.id]) || [];
                console.log('Child Cards:', children);
                var listContainer = document.getElementById("childCardsList");
                var totalPoints = 0;

                if (children.length === 0) {
                    return;
                }

                var promises = children.map(function(child) {
                    return t.get('card', 'shared', 'storyPoints', { card: child.id }).then(function(points) {
                        console.log('Retrieved Points for Child:', child.id, points);
                        var tempContainer = document.createElement("div");
                        points = parseInt(points, 10) || 0;
                        totalPoints += points;
                        console.log('Child:', child, 'Points:', points, 'Total Points:', totalPoints);
                        var listItem = document.createElement("li");
                        var link = document.createElement("a");
                        link.href = `https://trello.com/c/${child.id}`;
                        link.target = "_blank";
                        link.textContent = ` [${points} SP] - ${child.name}`;
                        listItem.appendChild(link);
                        tempContainer.appendChild(listItem);
                        return tempContainer;
                    }).catch(function(error) {
                        console.error('Error retrieving points for child:', child.id, error);
                    });
                });

                Promise.all(promises).then(function(tempContainers) {
                    tempContainers.forEach(function(tempContainer) {
                        while (tempContainer.firstChild) {
                            listContainer.appendChild(tempContainer.firstChild);
                        }
                    });
                    var totalPointsElement = document.createElement("h3");
                    totalPointsElement.textContent = `Total Story Points: ${totalPoints}`;
                    listContainer.insertBefore(totalPointsElement, listContainer.firstChild);
                    console.log('Total Points Element:', totalPointsElement);
                }).catch(function(error) {
                    console.error('Error fetching story points:', error);
                });
            });
        });
    </script>
</head>
<body>
    <ul id="childCardsList"></ul>
</body>
</html>